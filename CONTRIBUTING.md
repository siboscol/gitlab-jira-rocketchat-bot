# Contributing to Gitlab/Jira RocketChat Bot Service

The following is a set of guidelines for contributing to the Gitlab Workflow Service project.

## About

### Environment variables

The `.env.example` should list all the environment variables that the application needs to run.

A `.env` file with the environement variable key/value pairs can be added at the root of the project. The `dotenv` package imported in `/src/config/index.js` will make those variables available to the app.

### Project structure

The project is structured as follows:

- `/src`: server source files
  - `/api`: API related files
    - `/controllers`: request handlers
    - `/middlewares`: middleware definitions
    - `/routes`: route definitions
  - `/config`: configuration files (database options, logging configuration, etc)
  - `/services`: business logic files
  - `/utils`: utilities and helpers
  - `index.js`: entry point of the application that holds all the Express server configuration (middlewares, routes, error handling...)

When running the app or performing some commands, additional folders (ignored by Git) will be created such as:

- `/logs`: application logs (errors, info, etc...) generated by `winston` when the application is running

### Routing

#### How to

- All routes should be defined in `/src/api`
- For each main route endpoint, two files with the route endpoint as file name should be added to the `/routes` and `/controllers` folders
- All the business logic (retrieving, creating or updating data, etc) should be defined in the `/src/services` folder

#### Example

To define a new endpoint `/articles` and two routes `GET /articles` and `GET /articles/:id`, follow the steps below.

- Create the service with the business logic to retrieve the articles:

  - Create a new file called `article.js` in `/src/services`
  - In this new file, define and export two new methods `getAllArticles` and `getArticleById`:

    ```javascript
    module.exports = {
      async getAllArticles() {
        const articles = await Article.findAll();

        return articles;
      },

      async getArticleById(id) {
        const article = await Article.findByPk(id);

        return article;
      },
    };
    ```

- Create the controller:

  - Create a new file `articles.js` in `/src/api/controllers`
  - In this new file, define and export the request handlers associated to these routes:

    ```javascript
    const ArticleService = require('../../services/article');

    module.exports = {
      async getArticles(req, res, next) {
        const articles = await ArticleService.getAllArticles();

        return articles;
      },

      async getArticle(req, res, next) {
        const { id } = req.params;

        const article = await ArticleService.getArticleById(id);

        return article;
      },
    };
    ```

- Create the route endpoints:

  - Create a new file `articles.js` in `/src/api/routes`
  - In this new file, initialize a router object, import the controller and the new routes with its associated request handlers:

    ```javascript
    const Router = require('express-promise-router').default;

    const articlesController = require('../controllers/articles');

    const router = Router();

    router.get('/', articlesController.getArticles);
    router.get('/:id', articlesController.getArticle);

    module.exports = router;
    ```

- Finally, import the routes in `/src/api/routes/index.js` and declare a new `/articles` route:

  ```javascript
  const articlesRouter = require('./articles');

  /**
   * API routes
   */
  router.use('/articles', articlesRouter);
  ```

### Error handling

HTTP error responses are handled by the `httpErrorHandler` middleware from [@kazaar/express-error-handler](https://www.npmjs.com/package/@kazaar/express-error-handler).

```javascript
app.use(httpErrorHandler);
```

When an error is thrown inside of a controller with `next()` or `throw`, this middleware will parse the error as a standard HTTP error to retrieve the error details, log the error and send back the error to the client.

To throw custom HTTP errors, use the `http-errors` module:

```javascript
const { NotFound } = require('http-errors');

module.exports = {
  async getArticleById(id) {
    const article = await Article.findByPk(id);

    if (!article) {
      throw new NotFound('Article not found.');
    }

    return article;
  },
};
```

In addition, the routes defined in `/src/api/routes` should use the `Router` from the `express-promise-router` package instead of the `express` package. It provides a convenient way to write async controller methods without `try/catch` blocks and `next()` (see [express-promise-router](https://github.com/express-promise-router/express-promise-router)).

### Logs

When running, the application outputs some logs. Two modules are used for this:

- [winston](https://github.com/winstonjs/winston): handles all application logs and writes the output to configured transports (file, console, etc)
- [morgan](https://github.com/expressjs/morgan): logs all incoming HTTP requests

In production mode (`NODE_ENV` set to `production`), the application will not output logs to the console.

Please refer to `/config/logger.js` to see winston configuration.

### Version update

When updating the project's version number, do not forget to update:

- The `version` field in `package.json`
- The `info > version` field in `/src/api/doc/openapi.yaml`

## Style Guide

### ES6

JavaScript files located in `/src` are written in ES6 syntax (see [ECMAScript 6](https://www.w3schools.com/js/js_es6.asp)).

Most of the ES6 features are supported by the latest versions of Node (`async/await`, `let`, `const`...). However, some features like ES6's `import/export` require to be "transpiled" first for Node.js to understand them.

If you want to use ES6's `import/export` syntax instead of the CommonJS `require/module.exports` syntax, use [Babel](https://babeljs.io/).

### Filenames

All filenames should use `kebab-case`.

### Formatting

Formatting rules are defined in `.editorconfig` and `.prettierrc`.

General formatting rules are:

- Indentation of **2 spaces**
- Max line length of **120 characters**
- **Single quotes** instead of double quotes

The rules defined in `.editorconfig` ensure that the coding style guide will stay consistent between different editors (see [EditorConfig](https://editorconfig.org/) for more info).

The rules defined in `.prettierrc` provide more advanced formatting options (see [Linting](#Linting) section below).

### Linting

#### ESLint & Prettier

This project uses:

- [ESLint](https://eslint.org/) for JavaScript errors linting and best practices
- [Prettier](https://prettier.io/docs/en/index.html) for code formatting

Two npm commands are available:

- `npm run lint`
- `npm run lint:fix`

The first one will check for linting and formatting errors and the second one will try to automatically fix these errors. Under the hood, these two commands run ESlint on `*.js` files and Prettier on `*.{json,md,html,yaml,css}` files. All files and folders defined in `.gitignore` will be ignored.

Configuration for these tools are defined in `.eslintrc` and `.prettierrc`. This project essentially uses Airbnb's [JavaScript Style Guide](https://github.com/airbnb/javascript) along with some eslint plugins to ensure coding best practices.

#### Pre-commit hook

In addition to these commands, a git pre-commit hook runs before each commit to ensure that linting and formatting are ok. All staged files run through the same linting process as the `lint:fix` npm command.

The hook was created with `husky` and configured to run `lint-staged`. It is defined in `package.json`.

More info:

- [Git hooks](https://git-scm.com/book/uz/v2/Customizing-Git-Git-Hooks)
- [husky](https://github.com/typicode/husky)
- [lint-staged](https://github.com/okonet/lint-staged)

### JSDoc

JavaScript functions should be annotated with [JSDoc](https://devhints.io/jsdoc). This allows to:

- Check the type of JavaScript code during code time
- Facilitate code readability
- Produce code documentation
